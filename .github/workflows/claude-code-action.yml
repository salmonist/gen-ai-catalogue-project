name: Claude Code Action - AI Article Generation

on:
  workflow_dispatch:
    inputs:
      tool_url:
        description: 'AIãƒ„ãƒ¼ãƒ«ã®URL'
        required: true
        type: string
        default: 'https://elevenlabs.io'
      
      primary_keyword:
        description: 'SEOå¯¾ç­–ã®ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'
        required: true
        type: string
        default: 'AI tool review 2025'
      
      category:
        description: 'ãƒ„ãƒ¼ãƒ«ã®ã‚«ãƒ†ã‚´ãƒª'
        required: false
        type: string
        default: 'éŸ³å£°AI'
      
      target_length:
        description: 'ç›®æ¨™æ–‡å­—æ•°'
        required: false
        type: number
        default: 1600
      
      auto_publish:
        description: 'WordPressã«è‡ªå‹•æŠ•ç¨¿ã™ã‚‹'
        required: false
        type: boolean
        default: false

jobs:
  generate-article:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install anthropic requests beautifulsoup4 markdown python-wordpress-xmlrpc
    
    - name: Generate AI article
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python3 scripts/generate_article.py \
          --url "${{ github.event.inputs.tool_url }}" \
          --keyword "${{ github.event.inputs.primary_keyword }}" \
          --category "${{ github.event.inputs.category }}" \
          --target-length ${{ github.event.inputs.target_length }}
    
    - name: Quality check
      id: quality-check
      run: |
        # ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã®å“è³ªã‚’ãƒã‚§ãƒƒã‚¯
        LATEST_ARTICLE=$(ls -t content/*.md | head -1)
        
        if [ -f "$LATEST_ARTICLE" ]; then
          WORD_COUNT=$(wc -w < "$LATEST_ARTICLE")
          echo "Generated article: $LATEST_ARTICLE"
          echo "Word count: $WORD_COUNT"
          echo "article_path=$LATEST_ARTICLE" >> $GITHUB_OUTPUT
          echo "word_count=$WORD_COUNT" >> $GITHUB_OUTPUT
          
          if [ $WORD_COUNT -lt 800 ]; then
            echo "âš ï¸ Warning: Article is shorter than expected ($WORD_COUNT words)"
            echo "quality_status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Article quality check passed"
            echo "quality_status=passed" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ No article was generated"
          echo "quality_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Create Pull Request
      if: steps.quality-check.outputs.quality_status != 'failed'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          feat: Claude Code Actionã§è¨˜äº‹ç”Ÿæˆ
          
          - URL: ${{ github.event.inputs.tool_url }}
          - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ github.event.inputs.primary_keyword }}
          - ã‚«ãƒ†ã‚´ãƒª: ${{ github.event.inputs.category }}
          - æ–‡å­—æ•°: ${{ steps.quality-check.outputs.word_count }}èª
        
        title: "ğŸ¤– AIè¨˜äº‹ç”Ÿæˆ: ${{ github.event.inputs.category }} - ${{ github.event.inputs.primary_keyword }}"
        
        body: |
          ## ğŸ“ AIè¨˜äº‹ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ
          
          **Claude Code Action**ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã§ã™ã€‚
          
          ### ğŸ“Š ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          - **å¯¾è±¡URL**: ${{ github.event.inputs.tool_url }}
          - **SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ${{ github.event.inputs.primary_keyword }}
          - **ã‚«ãƒ†ã‚´ãƒª**: ${{ github.event.inputs.category }}
          - **ç›®æ¨™æ–‡å­—æ•°**: ${{ github.event.inputs.target_length }}èª
          
          ### ğŸ“ˆ å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
          - **å®Ÿéš›ã®æ–‡å­—æ•°**: ${{ steps.quality-check.outputs.word_count }}èª
          - **å“è³ªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.quality-check.outputs.quality_status }}
          
          ### ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          - `${{ steps.quality-check.outputs.article_path }}`
          
          ### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã®ä½œæ¥­
          1. è¨˜äº‹å†…å®¹ã®ç¢ºèªãƒ»ç·¨é›†
          2. ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã®è¨­å®š
          3. ç”»åƒã®è¿½åŠ ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          4. WordPressã¸ã®æŠ•ç¨¿
          
          ---
          *ã“ã®PRã¯ Claude Code Action ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
        
        branch: claude/article-${{ github.run_number }}
        delete-branch: true
    
    - name: Auto-publish to WordPress
      if: >
        github.event.inputs.auto_publish == 'true' && 
        steps.quality-check.outputs.quality_status == 'passed'
      env:
        WORDPRESS_URL: ${{ secrets.WORDPRESS_URL }}
        WORDPRESS_USERNAME: ${{ secrets.WORDPRESS_USERNAME }}
        WORDPRESS_PASSWORD: ${{ secrets.WORDPRESS_PASSWORD }}
      run: |
        python3 scripts/deploy_to_wordpress.py \
          --article-path "${{ steps.quality-check.outputs.article_path }}" \
          --status draft
    
    - name: Notify completion
      if: always()
      run: |
        echo "ğŸ‰ Claude Code Action workflow completed"
        echo "Status: ${{ steps.quality-check.outputs.quality_status }}"
        echo "Generated article: ${{ steps.quality-check.outputs.article_path }}" 